# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    build_app(
      scheme: "DailyRoutine",
      export_method: "app-store",  # App Storeìš© ë¹Œë“œ
      export_options: {
        provisioningProfiles: {
          "com.ezyeun.ios.dailyroutine" => "Daily Routine Distribution Profile"
        }
      },
      suppress_xcode_output: false,
      xcpretty_formatter: nil
    )
    api_key = app_store_connect_api_key(
      key_id: "PQ2AAF864L",
      issuer_id: "d506bc25-23b2-4a16-99e8-ec6e685db84f",
      key_filepath: "./fastlane/AuthKey_PQ2AAF864L.p8",
      in_house: false
    )

    upload_to_testflight(
      api_key: api_key
    )
  end

  desc "Build for Release to TestFlight"
  lane :release do    
    add_build_number(app_id: "com.ezyeun.ios.dailyroutine")

    build_app(
      scheme: "DailyRoutine",
      export_method: "app-store",  # App Storeìš© ë¹Œë“œ
      export_options: {
        provisioningProfiles: {
          "com.ezyeun.ios.dailyroutine" => "Daily Routine Distribution Profile"
        }
      },
      suppress_xcode_output: false,
      xcpretty_formatter: nil
    )

    api_key = app_store_connect_api_key(
      key_id: "PQ2AAF864L",
      issuer_id: "d506bc25-23b2-4a16-99e8-ec6e685db84f",
      key_filepath: "./fastlane/AuthKey_PQ2AAF864L.p8",
      in_house: false
    )

    upload_to_testflight(
      api_key: api_key
    )
  end

  lane :add_build_number do |options|
    appId = options[:app_id]
    
    # í”„ë¡œì íŠ¸ ê²½ë¡œ ì„¤ì • (ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜)
    project_path = File.expand_path("../DailyRoutine.xcodeproj", File.dirname(__FILE__))
    
    puts "Project path: #{project_path}"
    
    # í˜„ì¬ ë¹Œë“œ ë²„ì „ ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: "1.0.0.1")
    current_build = get_build_number(xcodeproj: project_path)
    
    puts "Current build number: #{current_build}"
    
    # í˜„ì¬ ë¹Œë“œê°€ 4ìë¦¬ í˜•ì‹ì¸ì§€ í™•ì¸
    version_parts = current_build.to_s.split(".").map(&:to_i)
    
    # ë²„ì „ì´ 4ìë¦¬ê°€ ì•„ë‹ˆë©´ 1.0.0.1ë¶€í„° ì‹œì‘
    if version_parts.length != 4
      puts "âš ï¸  Build number is not in 4-part format. Resetting to 1.0.0.1"
      major = 1
      minor = 0
      patch = 0
      build = 1
    else
      major = version_parts[0]
      minor = version_parts[1]
      patch = version_parts[2]
      build = version_parts[3]
      
      # ë¹Œë“œ ë²ˆí˜¸ ì¦ê°€
      build += 1
      
      # ë¹Œë“œê°€ ë‘ ìë¦¬(10)ê°€ ë˜ë©´ patch ì¦ê°€, buildëŠ” 1ë¡œ ì´ˆê¸°í™”
      if build >= 10
        patch += 1
        build = 1
        puts "ğŸ“¦ Patch incremented to #{patch}, build reset to 1"
        
        # patchê°€ ë‘ ìë¦¬(10)ê°€ ë˜ë©´ minor ì¦ê°€, patchëŠ” 0ìœ¼ë¡œ ì´ˆê¸°í™”
        if patch >= 10
          minor += 1
          patch = 0
          puts "ğŸ“¦ Minor incremented to #{minor}, patch reset to 0"
        end
      end
    end
    
    # ìƒˆë¡œìš´ ë¹Œë“œ ë²„ì „ ìƒì„±
    new_build_number = "#{major}.#{minor}.#{patch}.#{build}"
    
    puts "âœ… Build number updated: #{current_build} â†’ #{new_build_number}"
    
    # xcodeproj íŒŒì¼ì„ ì§ì ‘ ìˆ˜ì •
    require 'xcodeproj'
    
    puts "Opening project at: #{project_path}"
    
    project = Xcodeproj::Project.open(project_path)
    
    # ë©”ì¸ ì•± íƒ€ê²Ÿë§Œ ì—…ë°ì´íŠ¸ (í…ŒìŠ¤íŠ¸ íƒ€ê²Ÿ ì œì™¸)
    project.targets.each do |target|
      # UI í…ŒìŠ¤íŠ¸ë‚˜ ìœ ë‹› í…ŒìŠ¤íŠ¸ íƒ€ê²Ÿ ì œì™¸
      next if target.name.include?("Tests")
      
      puts "Updating target: #{target.name}"
      target.build_configurations.each do |config|
        config.build_settings["CURRENT_PROJECT_VERSION"] = new_build_number
        puts "  - #{config.name}: #{new_build_number}"
      end
    end
    
    project.save
    puts "ğŸ’¾ Project saved successfully"
  end


#----------------------------------- ë¹Œë“œ ë²„ì „ ì¦ê°€ (x.x.x.x) start -------------------------------------#
private_lane :increase_build_version do

  if ENV['PLIST_PATH'] != nil

    # plistì—ì„œ ë²ˆë“¤ ë²„ì „ ê°€ì ¸ì˜¨ë‹¤.
    before_identifier = get_info_plist_value(path:ENV['PLIST_PATH'], key:"CFBundleVersion")
    version_array = before_identifier.split(".").map(&:to_i)
    next_version_number = ""
    # ë§ˆì§€ë§‰ ë²„ì „ì„ í•˜ë‚˜ ì˜¬ë¦°ë‹¤.
    if version_array.count < 5
      version_array[3] = version_array[3] + 1
      next_version_number = version_array.join(".")
    end

    # ë³€ê²½ëœ ë²„ì „ ì •ë³´ë¥¼ Plistì— ì €ì¥
    set_info_plist_value(path:ENV['PLIST_PATH'], key:"CFBundleVersion", value:next_version_number.to_s)
    set_info_plist_value(path:ENV['PLIST_PATH_NOTI_SERVICE'], key:"CFBundleVersion", value:next_version_number.to_s)
    set_info_plist_value(path:ENV['PLIST_PATH_NOTI_CONTENT'], key:"CFBundleVersion", value:next_version_number.to_s)

  else
    puts("do foreach")
    execute_for_all_envs{ increase_build_version }
  end
end
#----------------------------------- ë¹Œë“œ ë²„ì „ ì¦ê°€ (x.x.x.x) end -------------------------------------#
end